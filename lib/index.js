"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@debut/plugin-utils"),t=require("@tinkoff/invest-openapi-js-sdk"),r=require("binance-api-node"),s=require("@master-chief/alpaca"),i=require("cli-progress");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=n(t),o=n(r);const c=["Decline","Cancelled","Rejected","PendingCancel"];function l(e){return{o:e.o,h:e.h,l:e.l,c:e.c,time:Date.parse(e.time),v:e.v}}function u(e){switch(e){case"1min":return"1min";case"5min":return"5min";case"15min":return"15min";case"30min":return"30min";case"1h":return"hour";case"day":return"day"}throw new Error("Unsupported interval")}const h=["CANCELED","EXPIRED","PENDING_CANCEL","REJECTED"];function p(e){switch(e){case"1min":return r.CandleChartInterval.ONE_MINUTE;case"5min":return r.CandleChartInterval.FIVE_MINUTES;case"15min":return r.CandleChartInterval.FIFTEEN_MINUTES;case"30min":return r.CandleChartInterval.THIRTY_MINUTES;case"1h":return r.CandleChartInterval.ONE_HOUR;case"4h":return r.CandleChartInterval.FOUR_HOURS;case"day":return r.CandleChartInterval.ONE_DAY}throw new Error("Unsupported interval")}function d(e){switch(e){case"1min":return"1Min";case"1h":return"1Hour";case"day":return"1Day"}throw`Alpaca integration does not support ${e} timeframe`}const m=["new","accepted"];function g(e){const t="raw"in e?e.raw():e,r=Date.parse(t.t);return{o:t.o,h:t.h,l:t.l,c:t.c,v:t.v,time:r}}var f;!function(e){e[e.Unknown=0]="Unknown",e[e.Genetic=1]="Genetic",e[e.History=2]="History",e[e.Core=3]="Core"}(f||(f={}));class y{constructor(e,t){this.env=e,this.message=`${this.getErrorMessage()}  ${t}`}getErrorMessage(){switch(this.env){case f.History:return"Debut history error:";case f.Core:return"Debut core error:";case f.Genetic:return"Debut genetic error:";default:return"Debut unknown error:"}}}const w=e.cli.getTokens(),{atoken:b="alpacaKey",asecret:k="alpacaSecret"}=e.cli.getArgs(),v=w[b],D=w[k];let I=null;function O(){return I||(I=new s.AlpacaClient({credentials:{key:v,secret:D}})),I}async function T(t,r,s,i){if(e.date.isWeekend(t))return Promise.resolve([]);const n=900100;let a=[];if(Date.now()-n<r){r-=n;try{a=(await O().getBars({symbol:s,start:new Date(r-n+6e4),end:new Date(r+n),timeframe:d(i)})).bars}catch(e){}}return[...(await O().getBars({symbol:s,start:new Date(t),end:new Date(r),timeframe:d(i)})).bars,...a].map(g)}async function C(e,t,r,s){const i=p(s),n=e+432e5-1e3,a=`https://api.binance.com/api/v1/klines?symbol=${r}&interval=${i}&startTime=${n}&endTime=${t}&limit=720`,o=fetch(`https://api.binance.com/api/v1/klines?symbol=${r}&interval=${i}&startTime=${e}&endTime=${n}&limit=720`).then((e=>e.json())),c=fetch(a).then((e=>e.json())),l=await o||[],u=await c||[];if(!Array.isArray(u)||!Array.isArray(l))throw l.msg||u.msg;return function(e){const t=[];return e.forEach((e=>{const r={time:e[0],o:parseFloat(e[1]),c:parseFloat(e[4]),h:parseFloat(e[2]),l:parseFloat(e[3]),v:parseFloat(e[5])};r.c&&t.push(r)})),t}([...l,...u])}const S=e.cli.getTokens().tinkoff;let M=null,x=null;function P(){return M||(x=new Map,M=new a.default({apiURL:"https://api-invest.tinkoff.ru/openapi",secretToken:S,socketURL:"wss://api-invest.tinkoff.ru/openapi/md/v1/md-openapi/ws"})),M}const E=async(t,r,s,i)=>{const n=await async function(e){if(!(null==x?void 0:x.has(e))){const{figi:t}=await P().searchOne({ticker:e});x.set(e,t)}return x.get(e)}(s);if(e.date.isWeekend(t))return Promise.resolve([]);const a={from:e.date.toIsoString(t),to:e.date.toIsoString(r),figi:n,interval:u(i)};return(await P().candlesGet(a).then((e=>e.candles))).map(l)},L=864e5;async function A(t){let r;switch(t.broker){case"tinkoff":r=E;break;case"binance":r=C;break;case"alpaca":r=T}return async function(t,r){const{ticker:s,days:i,interval:n,gapDays:a,broker:o,noProgress:c=!1}=t,l=[],u=new Date;let h,p=(a?_(u.getTime()):u.getTime())-L*a,d=_(p-L*i),m=d,g=0,f=[],w=0;console.log(`History loading from [${o}] ${new Date(d).toLocaleDateString()}:\n`);const b=c?null:U();null==b||b.start(i,0);for(;m<=p;)try{if(m=d+L,h||(h=d),l.push(R(o,s,n,d,Math.min(m,p),r)),50===l.length||m>=p){const e=await $(l);f=f.concat(e),l.length=0,g=0,h=m}w++,null==b||b.update(w),d=m}catch(t){if(t instanceof y)return Promise.reject(t.message);g++,w=Math.max(w-l.length,0),null==b||b.update(w),l.length=0,d=h,await e.promise.sleep(1e4*Math.pow(2,g))}return null==b||b.update(i),null==b||b.stop(),f}(t,r)}async function R(t,r,s,i,n,a){const o=i/1e5,c=`history/${t}/${r}/${s}/${o}-${n/1e5}.txt`,l=e.file.readFile(c);if(o!==~~o)throw new y(f.History,`Incorrect day request interval, 'from' should be start of day, from: ${i}`);if(l)return Promise.resolve(JSON.parse(l));const u=await a(i,n,r,s);return e.date.isSameDay(new Date,new Date(i))||(e.file.ensureFile(c),e.file.saveFile(c,u)),u}async function $(e){const t=await Promise.all(e);let r=[];return t.forEach((e=>{e?r=r.concat(e.filter(Boolean)):console.log("missed data")})),r}function U(e=""){return new i.SingleBar({format:`${e} [{bar}] {percentage}% | {value} of {total} days`,stopOnComplete:!0},i.Presets.shades_grey)}function _(e){return~~(e/L)*L}class N{constructor(e){this.debut=e,this.plugins=[],this.findPlugin=e=>this.plugins.find((t=>t.name===e)),this.pluginCtx=Object.freeze({findPlugin:this.findPlugin,debut:this.debut})}register(e){for(const t of e)t&&!this.findPlugin(t.name)&&this.plugins.push(t)}getPublicAPI(){const e={};for(const t of this.plugins)"api"in t&&(e[t.name]=t.api);return Object.freeze(e)}syncReduce(e,...t){for(const r of this.plugins)this.runHook(e,r,...t)}async asyncSkipReduce(e,...t){for(const r of this.plugins){const s=await this.runHook(e,r,...t);if(s)return s}return!1}async asyncReduce(e,...t){for(const r of this.plugins)await this.runHook(e,r,...t)}runHook(e,t,...r){if(e in t)return t[e].call(this.pluginCtx,...r)}}exports.AlpacaTransport=class{constructor(){this.instruments=new Map;const t=e.cli.getTokens(),{atoken:r="alpacaKey",asecret:i="alpacaSecret"}=e.cli.getArgs(),n=t[r],a=t[i];this.api=new s.AlpacaClient({credentials:{key:n,secret:a}}),this.stream=new s.AlpacaStream({credentials:{key:n,secret:a},type:"market_data",source:"iex"}),this.stream.once("authenticated",(()=>{this.stream.on("error",(e=>console.warn(e)))}))}async getInstrument(t){if(this.instruments.has(t))return this.instruments.get(t);const r=await this.api.getAsset({asset_id_or_symbol:t}),{dailyBar:s,latestQuote:i,prevDailyBar:n}=await this.api.getSnapshot({symbol:t}),a=[null==i?void 0:i.bp,null==s?void 0:s.c,null==s?void 0:s.o,null==s?void 0:s.h,null==s?void 0:s.l,null==n?void 0:n.o,null==n?void 0:n.h,null==n?void 0:n.l,null==n?void 0:n.c].filter((e=>Boolean(e)&&parseInt(`${e}`)!==e)).reduce(((t,r)=>Math.min(t,e.orders.getMinIncrementValue(r))),1/0),o={figi:r.id,ticker:r.symbol,lot:1,pipSize:a,lotPrecision:1};return this.instruments.set(t,o),o}async subscribeToTick(t,r,s){try{const i=e.date.intervalToMs(s);let n=~~(Date.now()/i)*i,a=n+i,o={o:0,h:-1/0,l:1/0,c:0,v:0,time:n};const c=e=>{if("v"in e)o=g(e),r({...o}),n=o.time+i,a=n+i;else{Date.parse(e.t)<a&&o.c!==e.bp&&(o.o||(o.o=e.bp),o={...o,time:n,h:Math.max(o.h,e.bp),l:Math.min(o.l,e.bp),c:e.bp,v:0},r({...o}))}};return this.stream.subscribe("bars",[t]),this.stream.subscribe("quotes",[t]),this.stream.addListener("bar",c),this.stream.addListener("quote",c),()=>{this.instruments.delete(t),this.stream.unsubscribe("bars",[t]),this.stream.unsubscribe("quotes",[t]),this.stream.removeListener("bar",c),this.stream.removeListener("quote",c)}}catch(t){e.debug.logDebug(t)}}async placeOrder(t){const{type:r,lots:s,sandbox:i,learning:n,ticker:a,currency:o}=t;let c=0;if(i||n)return this.placeSandboxOrder(t);try{const i=await this.api.placeOrder({symbol:a,side:"BUY"===r?"buy":"sell",type:"market",qty:s,time_in_force:"fok"});if(!m.includes(i.status))throw i;c&&e.debug.logDebug(" retry success");return{...t,executedLots:i.filled_qty||t.lots,orderId:`${i.id}`,commission:{currency:o,value:0},price:i.filled_avg_price||t.price}}catch(r){if(!c||c<=10){e.debug.logDebug(" error order place \n",r),c++;const s=Math.floor(e.math.clamp(1e3*Math.pow(3+Math.random(),c),3e3,3e5)+6e4*Math.random());if(await e.promise.sleep(s),this.instruments.has(t.ticker))return this.placeOrder(t)}throw e.debug.logDebug(" retry failure with order",t),r}}async placeSandboxOrder(t){const r={value:t.price*t.lots*5e-4,currency:t.currency};return{...t,orderId:e.orders.syntheticOrderId(t),executedLots:t.lots,commission:r}}prepareLots(e){return Math.floor(e)||1}},exports.BinanceTransport=class{constructor(){this.instruments=new Map;const t=e.cli.getTokens();let{btoken:r="binance",bsecret:s="binanceSecret"}=e.cli.getArgs();if(r=t[r],s=t[s],!r||!s)throw"Binance API token and secret are required!";this.api=o.default({apiKey:r,apiSecret:s})}async getInstrument(t){if(this.instruments.has(t))return this.instruments.get(t);const r=await this.api.prices({symbol:t});this.info=this.info||await this.api.exchangeInfo();const s=this.info.symbols.find((e=>e.symbol===t));if(!r[t]||!s)throw"Unknown instrument";const i=s.filters.find((e=>"LOT_SIZE"===e.filterType)),n=Number(i.minQty),a=1===n?0:e.math.getPrecision(n),o={figi:t,ticker:t,pipSize:e.orders.getMinIncrementValue(r[t]),lot:1,lotPrecision:a};return this.instruments.set(t,o),o}async subscribeToTick(e,t,r){const s=this.api.ws.candles(e,p(r),this.handlerAdapter(t));return()=>{this.instruments.delete(e),s({delay:0,fastClose:!0,keepClosed:!0})}}async placeOrder(t){const{type:r,lots:s,sandbox:i,ticker:n,learning:a,currency:o}=t;let c=0;if(i||a)return this.placeSandboxOrder(t);try{const i={quantity:String(s),side:"BUY"===r?"BUY":"SELL",symbol:n,type:"MARKET"};let a;switch(t.margin&&t.close&&(i.sideEffectType="AUTO_REPAY"),t.margin&&!t.close&&(i.sideEffectType="MARGIN_BUY"),!0){case t.futures:a=await this.api.futuresOrder(i);break;case t.margin:a=await this.api.marginOrder(i);break;default:a=await this.api.order(i)}if(h.includes(a.status))throw a;c>0&&e.debug.logDebug("retry success");const l=e.math.getPrecision(t.price);let u=0,p=0,d=0;a.fills.forEach((e=>{p+=Number(e.price),d+=Number(e.qty),t.ticker.startsWith(e.commissionAsset)&&(u+=Number(e.commission))})),p=e.math.toFixed(p/a.fills.length,l);const m=d-u;let g=this.prepareLots(m,n);const f=parseInt(`${g}`)===g?1:e.orders.getMinIncrementValue(g);for(;g>m&&g>0;)g=this.prepareLots(g-f,n);const y={value:t.price*t.lots*.001,currency:o};return{...t,orderId:`${a.orderId}`,executedLots:g,lots:g,commission:y,price:p}}catch(r){if(!c||c<=10){e.debug.logDebug("error order place",r),c=(c||0)+1;const s=Math.floor(e.math.clamp(1e3*Math.pow(3+Math.random(),c),3e3,3e5)+6e4*Math.random());if(await e.promise.sleep(s),this.instruments.has(n))return this.placeOrder(t)}throw e.debug.logDebug("retry failure with order",t),r}}async placeSandboxOrder(t){const r={value:t.price*t.lots*.002,currency:t.currency};return{...t,orderId:e.orders.syntheticOrderId(t),executedLots:t.lots,commission:r}}prepareLots(t,r){const s=this.instruments.get(r);if(!s)throw`Unknown instument ticker ${r}`;return 0===s.lotPrecision?Math.floor(t):e.math.toFixed(t,s.lotPrecision)}handlerAdapter(e){return t=>{e({o:parseFloat(t.open),h:parseFloat(t.high),l:parseFloat(t.low),c:parseFloat(t.close),v:parseFloat(t.volume),time:t.startTime})}}},exports.Debut=class{constructor(e,t){this.orders=[],this.candles=[],this.handler=async e=>{const t=this.marketTick&&this.marketTick.time!==e.time;if(await this.pluginDriver.asyncSkipReduce("onTick",e))return;const r=this.marketTick;this.marketTick=e,t&&r&&(this.updateCandles(r),await this.pluginDriver.asyncReduce("onCandle",r),await this.onCandle(r),await this.pluginDriver.asyncReduce("onAfterCandle",r)),await this.onTick(e)},this.transport=e,this.pluginDriver=new N(this),this.opts=t}get prevCandle(){return this.candles[1]}get currentCandle(){return this.candles[0]}registerPlugins(e){this.pluginDriver.register(e),this.plugins=this.pluginDriver.getPublicAPI(),this.pluginDriver.syncReduce("onInit")}async start(){await this.pluginDriver.asyncReduce("onStart"),this.instrument=await this.transport.getInstrument(this.opts.ticker);const e=await this.transport.subscribeToTick(this.opts.ticker,this.handler,this.opts.interval);return this.dispose=async()=>(await this.closeAll(),e(),this.pluginDriver.asyncReduce("onDispose")),this.dispose}getName(){return this.constructor.name}async closeAll(){if(!this.orders.length)return;const e=[];for(;this.orders.length>0;){const t=await this.closeOrder(this.orders[0]);e.push(t)}return e}async createOrder(e){const{c:t,time:r}=this.marketTick,{amount:s,lotsMultiplier:i=1,equityLevel:n=1,sandbox:a,currency:o,interval:c,broker:l,margin:u,futures:h}=this.opts,{ticker:p,figi:d,lot:m,pipSize:g}=this.instrument,f=t*m,y=this.transport.prepareLots(s/f*i,p);try{const s={broker:l,type:e,ticker:p,figi:d,currency:o,interval:c,author:this.getName(),price:t,lots:y,lotSize:m,pipSize:g,close:!1,sandbox:a,learning:this.learning,time:r,margin:u,futures:h,lotsMultiplier:i,equityLevel:n};if(await this.pluginDriver.asyncSkipReduce("onBeforeOpen",s))return;const f=await this.transport.placeOrder(s);return await this.pluginDriver.asyncReduce("onOpen",f),this.orders.push(f),await this.onOrderOpened(f),f}catch(e){console.log((new Date).toISOString(),"Ошибка создания ордера",e)}}async closeOrder(t){if(t.processing)return;const{c:r,time:s}=this.marketTick,{currency:i,interval:n,broker:a,margin:o,lotsMultiplier:c,equityLevel:l}=this.opts,{ticker:u,figi:h,lot:p,pipSize:d}=this.instrument,m=e.orders.inverseType(t.type),g=this.transport.prepareLots(t.executedLots*p,u);t.processing=!0;try{const e={broker:a,type:m,ticker:u,figi:h,currency:i,interval:n,author:this.getName(),price:r,lots:g,lotSize:p,pipSize:d,close:!0,openPrice:t.price,openId:t.orderId,sandbox:t.sandbox,learning:t.learning,time:s,margin:o,lotsMultiplier:c,equityLevel:l};if(await this.pluginDriver.asyncSkipReduce("onBeforeClose",e,t))return void(t.processing=!1);const f=await this.transport.placeOrder(e),y=this.orders.indexOf(t);return-1!==y&&this.orders.splice(y,1),await this.pluginDriver.asyncReduce("onClose",f,t),await this.onOrderClosed(f,t),t.processing=!1,f}catch(e){t.processing=!1,console.log((new Date).toISOString(),"Ошибка закрытия ордера",e)}}async learn(e=7){this.instrument=await this.transport.getInstrument(this.opts.ticker),this.learning=!0;const t=await A({broker:this.opts.broker,ticker:this.opts.ticker,days:e,interval:this.opts.interval,gapDays:0});for(;t.length;){const e=t.shift();await this.handler(e)}this.learning=!1}updateCandles(e){10===this.candles.length&&(this.candles.pop(),this.updateCandles=e=>{this.candles.pop(),this.candles.unshift(e)}),this.candles.unshift(e)}async onOrderClosed(e,t){}async onOrderOpened(e){}async onCandle(e){}async onTick(e){}},exports.TinkoffTransport=class{constructor(){this.instruments=new Map;let{token:t="tinkoff",proxyPort:r}=e.cli.getArgs();const s=e.cli.getTokens();if(r=r&&Number(r),t=s[t],!t)throw new Error("invalid tinkoff transport start params");let i="wss://api-invest.tinkoff.ru/openapi/md/v1/md-openapi/ws";r&&(i=`ws://localhost:${r}`),this.api=new a.default({apiURL:"https://api-invest.tinkoff.ru/openapi",socketURL:i,secretToken:t})}async getPrice(e){const t=await this.getInstrument(e),r=await this.api.orderbookGet({figi:t.figi,depth:1});return r.lastPrice||r.closePrice}async getInstrument(e){if(this.instruments.has(e))return this.instruments.get(e);const t=await this.api.searchOne({ticker:e}),r={figi:t.figi,ticker:t.ticker,lot:t.lot,pipSize:t.minPriceIncrement,lotPrecision:1};return this.instruments.set(e,r),r}async subscribeToTick(t,r,s){try{const{figi:e}=await this.getInstrument(t),i=this.api.candle({figi:e,interval:u(s)},(e=>{r(l(e))}));return()=>{this.instruments.delete(t),i()}}catch(t){e.debug.logDebug(t)}}async placeOrder(t){const{figi:r,type:s,lots:i,sandbox:n,learning:a}=t;let o=0;if(n||a)return this.placeSandboxOrder(t);try{const n="BUY"===s?"Buy":"Sell",a=await this.api.marketOrder({figi:r,lots:i,operation:n});if(a.rejectReason||a.message||c.includes(a.status))throw a;return o&&e.debug.logDebug(" retry success"),t={...a,...t}}catch(r){if(!o||o<=10){e.debug.logDebug(" error order place \n",r),o++;const s=Math.floor(e.math.clamp(1e3*Math.pow(3+Math.random(),o),3e3,3e5)+6e4*Math.random());if(await e.promise.sleep(s),this.instruments.has(t.ticker))return this.placeOrder(t)}throw e.debug.logDebug(" retry failure with order",t),r}}async placeSandboxOrder(t){const r={value:t.price*t.lots*5e-4,currency:"USD"};return{...t,orderId:e.orders.syntheticOrderId(t),executedLots:t.lots,commission:r}}prepareLots(e){return Math.floor(e)||1}},exports.createProgress=U,exports.generateOHLC=function(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r],i=~~(s.v/4),n={...s,h:s.o,l:s.o,c:s.o,v:i};let a={...n,h:s.h,c:s.h},o={...a,l:s.l,c:s.l},c={...o,c:s.c};s.o<s.c?(o={...n,l:s.l,c:s.l},a={...o,h:s.h,c:s.h},c={...a,c:s.c},t.push(n,o,a,c)):t.push(n,a,o,c)}return t},exports.getHistory=A;
