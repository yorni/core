#!/usr/bin/env node
"use strict";var e=require("@debut/plugin-utils"),t=require("./genetic-8697fca0.js"),r=require("./tester-transport-0f71243c.js");require("async-genetic"),require("cli-progress"),require("@master-chief/alpaca"),require("binance-api-node"),require("@tinkoff/invest-openapi-js-sdk");const o=e.cli.getArgs(),{bot:s,ticker:i,log:a,amount:c=1e4,days:n=1e3,hours:l=0,gen:u=12,pop:g=2e3,ohlc:p,gap:f=0,best:d=5,daysForStudy:k=2,daysForTrade:b=1}=o;let y=Number(c);const m=e.cli.getBotData(s);async function w(e,t,o,s){try{const i=new r.TesterTransport({ohlc:p,comission:e.fee,broker:e.broker,ticker:e.ticker}),a=await t.create(i,e,1);e||process.stdout.write("Genetic CLI error: Put config in bot cfgs.ts file");const{broker:c="tinkoff",ticker:n,interval:l}=e;let u=await r.getHistory({broker:c,ticker:n,interval:l,days:o,gapDays:s});t.ticksFilter&&(u=u.filter(t.ticksFilter(e))),console.log("Tested in ",u.length," candles..."),i.setTicks(u),await a.start(),await i.run(),await a.closeAll(),await a.dispose(),console.log(t.stats(a)),console.log(t.score(a)),y+=Number(t.score(a))}catch(e){console.log(e)}}!async function(){if(!m)return void process.stdout.write("Genetic CLI error: Incorrect configuration");const{configs:e,meta:r}=m;for(let o=0;o<n;o++){const s={...e[i],ticker:i,amount:Number(c)},n={days:k,hours:l,generations:u,populationSize:g,log:a,ohlc:p,gapDays:f+b+o,validateSchema:r.validate,score:r.score,stats:r.stats,create:r.create,ticksFilter:r.ticksFilter,best:d},m=new t.GeneticWrapper(n);let h=await m.start(r.parameters,s);h=h.map(((e,t)=>(e.config.id=t,e))),console.log(h[0].config);const q=h[0].config;q.amount=y,await w(q,r,b,f+b+o-1)}}();
