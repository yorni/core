#!/usr/bin/env node
"use strict";var e=require("@debut/plugin-utils"),t=require("cli-progress"),r=require("@master-chief/alpaca"),n=require("binance-api-node");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i,a=s(require("@tinkoff/invest-openapi-js-sdk"));!function(e){e[e.Unknown=0]="Unknown",e[e.Genetic=1]="Genetic",e[e.History=2]="History",e[e.Core=3]="Core"}(i||(i={}));class o{constructor(e,t){this.env=e,this.message=`${this.getErrorMessage()}  ${t}`}getErrorMessage(){switch(this.env){case i.History:return"Debut history error:";case i.Core:return"Debut core error:";case i.Genetic:return"Debut genetic error:";default:return"Debut unknown error:"}}}function c(e){switch(e){case"1min":return"1Min";case"1h":return"1Hour";case"day":return"1Day"}throw`Alpaca integration does not support ${e} timeframe`}function l(e){const t="raw"in e?e.raw():e,r=Date.parse(t.t);return{o:t.o,h:t.h,l:t.l,c:t.c,v:t.v,time:r}}const u=e.cli.getTokens(),{atoken:h="alpacaKey",asecret:p="alpacaSecret"}=e.cli.getArgs(),f=u[h],d=u[p];let m=null;function w(){return m||(m=new r.AlpacaClient({credentials:{key:f,secret:d}})),m}async function g(t,r,n,s){if(e.date.isWeekend(t))return Promise.resolve([]);const i=900100;let a=[];if(Date.now()-i<r){r-=i;try{a=(await w().getBars({symbol:n,start:new Date(r-i+6e4),end:new Date(r+i),timeframe:c(s)})).bars}catch(e){}}return[...(await w().getBars({symbol:n,start:new Date(t),end:new Date(r),timeframe:c(s)})).bars,...a].map(l)}async function y(e,t,r,s){const i=function(e){switch(e){case"1min":return n.CandleChartInterval.ONE_MINUTE;case"5min":return n.CandleChartInterval.FIVE_MINUTES;case"15min":return n.CandleChartInterval.FIFTEEN_MINUTES;case"30min":return n.CandleChartInterval.THIRTY_MINUTES;case"1h":return n.CandleChartInterval.ONE_HOUR;case"4h":return n.CandleChartInterval.FOUR_HOURS;case"day":return n.CandleChartInterval.ONE_DAY}throw new Error("Unsupported interval")}(s),a=e+432e5-1e3,o=`https://api.binance.com/api/v1/klines?symbol=${r}&interval=${i}&startTime=${a}&endTime=${t}&limit=720`,c=fetch(`https://api.binance.com/api/v1/klines?symbol=${r}&interval=${i}&startTime=${e}&endTime=${a}&limit=720`).then((e=>e.json())),l=fetch(o).then((e=>e.json())),u=await c||[],h=await l||[];if(!Array.isArray(h)||!Array.isArray(u))throw u.msg||h.msg;return function(e){const t=[];return e.forEach((e=>{const r={time:e[0],o:parseFloat(e[1]),c:parseFloat(e[4]),h:parseFloat(e[2]),l:parseFloat(e[3]),v:parseFloat(e[5])};r.c&&t.push(r)})),t}([...u,...h])}function k(e){return{o:e.o,h:e.h,l:e.l,c:e.c,time:Date.parse(e.time),v:e.v}}function v(e){switch(e){case"1min":return"1min";case"5min":return"5min";case"15min":return"15min";case"30min":return"30min";case"1h":return"hour";case"day":return"day"}throw new Error("Unsupported interval")}const b=e.cli.getTokens().tinkoff;let D=null,T=null;function $(){return D||(T=new Map,D=new a.default({apiURL:"https://api-invest.tinkoff.ru/openapi",secretToken:b,socketURL:"wss://api-invest.tinkoff.ru/openapi/md/v1/md-openapi/ws"})),D}const C=async(t,r,n,s)=>{const i=await async function(e){if(!(null==T?void 0:T.has(e))){const{figi:t}=await $().searchOne({ticker:e});T.set(e,t)}return T.get(e)}(n);if(e.date.isWeekend(t))return Promise.resolve([]);const a={from:e.date.toIsoString(t),to:e.date.toIsoString(r),figi:i,interval:v(s)};return(await $().candlesGet(a).then((e=>e.candles))).map(k)},I=864e5;async function E(t,r,n,s,a,c){const l=s/1e5,u=`history/${t}/${r}/${n}/${l}-${a/1e5}.txt`,h=e.file.readFile(u);if(l!==~~l)throw new o(i.History,`Incorrect day request interval, 'from' should be start of day, from: ${s}`);if(h)return Promise.resolve(JSON.parse(h));const p=await c(s,a,r,n);return e.date.isSameDay(new Date,new Date(s))||(e.file.ensureFile(u),e.file.saveFile(u,p)),p}async function S(e){const t=await Promise.all(e);let r=[];return t.forEach((e=>{e?r=r.concat(e.filter(Boolean)):console.log("missed data")})),r}function U(e){return~~(e/I)*I}exports.TesterTransport=class{constructor(e){this.ticks=[],this.handlers=[],this.opts=e,this.reset(),this.fee=this.opts.comission/100||3e-4}async getInstrument(){if(!this.ticks)throw new Error("transport is not ready, set ticks before bot.start() call");this.precision||this.ticks.slice(-20).forEach((e=>{const t=`${String(e.c).split(".").pop()}`.length;t>this.precision&&(this.precision=t)}));const e=Number(`${parseFloat("0").toFixed(this.precision-1)}1`);return{figi:"test",ticker:this.opts.ticker,pipSize:e,lotPrecision:10,lot:1,currency:"USD"}}setTicks(e){this.ticks=e.slice(),this.precision=0,this.opts.ohlc&&(this.ticks=function(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r],s=~~(n.v/4),i={...n,h:n.o,l:n.o,c:n.o,v:s};let a={...i,h:n.h,c:n.h},o={...a,l:n.l,c:n.l},c={...o,c:n.c};n.o<n.c?(o={...i,l:n.l,c:n.l},a={...o,h:n.h,c:n.h},c={...a,c:n.c},t.push(i,o,a,c)):t.push(i,a,o,c)}return t}(this.ticks),console.log("OHLC Ticks is enabled, total ticks:",this.ticks.length))}async run(t){if(t){const r=this.handlers.length;if(await e.promise.sleep(1e3),r!==this.handlers.length)return this.run(t)}return this.tickLoop()}reset(){this.handlers.length=0,this.complete=new Promise((e=>{this.resolve=e}))}subscribeToTick(e,t){return this.handlers.push(t),Promise.resolve((()=>{const e=this.handlers.indexOf(t);-1!==e&&this.handlers.splice(e,1)}))}async tickLoop(){let e=0,t=this.ticks[0];for(;t;){let r=this.handlers[0],n=0;for(;r;)await r(t),r=this.handlers[++n];t=this.ticks[++e]}this.resolve()}async placeOrder(t){const r={value:t.price*t.lots*this.fee,currency:"USD"};return{...t,orderId:e.orders.syntheticOrderId(t),executedLots:t.lots,commission:r}}placeSandboxOrder(e){return this.placeOrder(e)}async getUsdBalance(){return 1/0}prepareLots(t){switch(this.opts.broker){case"binance":return e.math.toFixed(t,6);case"tinkoff":default:return Math.floor(t)||1}}},exports.getHistory=async function(r){let n;switch(r.broker){case"tinkoff":n=C;break;case"binance":n=y;break;case"alpaca":n=g}return async function(r,n){const{ticker:s,days:i,interval:a,gapDays:c,broker:l,noProgress:u=!1}=r,h=[],p=new Date;let f,d=(c?U(p.getTime()):p.getTime())-I*c,m=U(d-I*i),w=m,g=0,y=[],k=0;console.log(`History loading from [${l}] ${new Date(m).toLocaleDateString()}:\n`);const v=u?null:function(e=""){return new t.SingleBar({format:`${e} [{bar}] {percentage}% | {value} of {total} days`,stopOnComplete:!0},t.Presets.shades_grey)}();null==v||v.start(i,0);for(;w<=d;)try{if(w=m+I,f||(f=m),h.push(E(l,s,a,m,Math.min(w,d),n)),50===h.length||w>=d){const e=await S(h);y=y.concat(e),h.length=0,g=0,f=w}k++,null==v||v.update(k),m=w}catch(t){if(t instanceof o)return Promise.reject(t.message);g++,k=Math.max(k-h.length,0),null==v||v.update(k),h.length=0,m=f,await e.promise.sleep(1e4*Math.pow(2,g))}return null==v||v.update(i),null==v||v.stop(),y}(r,n)};
